<html>
 
<head>
    <title>Mosquitto Websockets</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="./mqttws31.js" type="text/javascript"></script>
    <script src="./jquery.min.js" type="text/javascript"></script>
    <script src="./config.js" type="text/javascript"></script>
</head>
 
<body>
    <table id="moveRobot" border="0" cellspading="0" cellspacing="0" allign="center" vallign="middle"
        style="font-family: Arial, Helvetica, sans-serif;">
        <tr>
            <td></td>
            <td name="Front">&nbsp;&nbsp;Front 1&nbsp;&nbsp;</td>
            <td></td>
        </tr>
        <tr>
            <td name="Left">&nbsp;&nbsp;Left&nbsp;&nbsp;</td>
            <td name="Stop">&nbsp;&nbsp;Stop&nbsp;&nbsp;</td>
            <td name="Right">&nbsp;&nbsp;Right&nbsp;&nbsp;</td>
        </tr>
        <tr>
            <td></td>
            <td name="Back" class="btn">&nbsp;&nbsp;Back&nbsp;&nbsp;</td>
            <td></td>
        </tr>
    </table>
    <hr />
    <div>
        <div>Subscribed to <input type='text' id='topic' disabled />
            Status: <input type='text' id='status' size="80" disabled /></div>
 
        <ul id='ws' style="font-family: 'Courier New', Courier, monospace;"></ul>
    </div>
    <hr />
    <form name="smessage" action="" style="visibility: hidden;">
        Message: <input type="text" name="message"><br><br>
        Publish Topic: <input type="text" name="Ptopic"><br><br>
        <input type="button" value="Submit" onclick="return send_message()">
    </form>
</body>
 
</html>
 
<script>
    const clickedColor = "#3399FF";
    const inactiveColor = "silver";
    const tdHeight = "30px"
 
    const moveRobotTdNames = ["Stop", "Front", "Right", "Back", "Left"];
    const moveRobot = document.getElementById("moveRobot");
 
    const mqttConf = {
 
        //HIVE
        hostname: "8ec3c4be17e94dbbb615e64d74ae428e.s1.eu.hivemq.cloud",
        port: 8883
 
        //LOCAL
        //hostname: "0.0.0.0",
        //port: 1884
    }
 
    var oldTd = document.getElementsByName("Stop")[0];
 
    function init() {
        let td;
        for (tdName of Object.values(moveRobotTdNames)) {
            td = document.getElementsByName(tdName)[0];
            td.style.cursor = "hand";
            td.bgColor = inactiveColor;
            td.height = tdHeight
        }
 
        oldTd.bgColor = clickedColor;
 
        // Create a client instance
        client = new Paho.MQTT.Client(mqttConf.hostname, Number(mqttConf.port), "clientId");
 
        // set callback handlers
        //client.onConnectionLost = onConnectionLost;
        //client.onMessageArrived = onMessageArrived;
 
        // connect the client
        client.connect({ 
            onSuccess: onConnect
        });
 
        // called when the client connects
        function onConnect() {
            // Once a connection has been made, make a subscription and send a message.
            console.log("onConnect");
            client.subscribe("news");
            message = new Paho.MQTT.Message("Hello");
            message.destinationName = "news";
            client.send(message);
        }
 
        moveRobot.addEventListener('click', function (e) {
            tdTarget = e.target;
            tdName = tdTarget.getAttribute('name');
 
            tdTarget.bgColor = clickedColor;
            oldTd.bgColor = inactiveColor;
            oldTd = tdTarget;
 
            control("move", tdName);
        });
    }
 
    var mqtt;
    var reconnectTimeout = 2000;
 
    function MQTTconnect() {
        if (typeof path == "undefined") {
            path = '/mqtt';
        }
        mqtt = new Paho.MQTT.Client(
            host,
            port,
            path,
            "web_" + parseInt(Math.random() * 100, 10)
        );
        var options = {
            timeout: 3,
            useSSL: useTLS,
            cleanSession: cleansession,
            onSuccess: onConnect,
            onFailure: function (message) {
                console.log(message);
                $('#status').val("Connection failed: " + message.errorMessage + "Retrying");
                setTimeout(MQTTconnect, reconnectTimeout);
            }
        };
 
        mqtt.onConnectionLost = onConnectionLost;
        mqtt.onMessageArrived = onMessageArrived;
 
        if (username != null) {
            options.userName = username;
            options.password = password;
        }
        console.log("Host=" + host + ", port=" + port + ", path=" + path + " TLS = " + useTLS + " username=" + username + " password=" + password);
        mqtt.connect(options);
    }
 
    function onConnect() {
        $('#status').val('Connected to ' + host + ':' + port + path);
        // Connection succeeded; subscribe to our topic
        mqtt.subscribe(topic, { qos: 0 });
        $('#topic').val(topic);
    }
 
    function onConnectionLost(response) {
        setTimeout(MQTTconnect, reconnectTimeout);
        $('#status').val("connection lost: " + responseObject.errorMessage + ". Reconnecting");
 
    };
 
    function onMessageArrived(message) {
 
        var topic = message.destinationName;
        var payload = message.payloadString;
 
        $('#ws').prepend('<li>' + topic + ' = ' + payload + '</li>');
    };
 
    function send_message() {
        var msg = document.forms["smessage"]["message"].value;
        console.log(msg);
 
        var topic = document.forms["smessage"]["Ptopic"].value;
        message = new Paho.MQTT.Message(msg);
        if (topic == "")
            message.destinationName = "test-topic"
        else
            message.destinationName = "autogo/tank-01/"+topic;
        mqtt.send(message);
        return false;
    }
 
 
    function control(topic, message) {
        message = new Paho.MQTT.Message(message);
        if (topic == undefined)
            message.destinationName = "test-topic"
        else
            message.destinationName = "autogo/tank-01/"+topic;
        mqtt.send(message);
        return false;
    }
 
 
    $(document).ready(function () {
        MQTTconnect();
        init();
    });
 
</script>